<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>readers/h5ad.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/LTLA/bakana" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AdtNormalizationState.html">AdtNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="AdtPcaState.html">AdtPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="AdtQualityControlState.html">AdtQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="ArtifactDbSummarizedExperimentDatasetBase.html">ArtifactDbSummarizedExperimentDatasetBase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setAdtCountAssay">setAdtCountAssay</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setAdtExperiment">setAdtExperiment</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setCrisprCountAssay">setCrisprCountAssay</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setCrisprExperiment">setCrisprExperiment</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setRnaCountAssay">setRnaCountAssay</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#setRnaExperiment">setRnaExperiment</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentDatasetBase.html#summary">summary</a></li></ul></li><li><a href="ArtifactDbSummarizedExperimentResultBase.html">ArtifactDbSummarizedExperimentResultBase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#setPrimaryAssay">setPrimaryAssay</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="ArtifactDbSummarizedExperimentResultBase.html#summary">summary</a></li></ul></li><li><a href="BatchCorrectionState.html">BatchCorrectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchCorrected">fetchCorrected</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchNumberOfCells">fetchNumberOfCells</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchNumberOfDimensions">fetchNumberOfDimensions</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CellFilteringState.html">CellFilteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellFilteringState.html#applyFilter">applyFilter</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredBlock">fetchFilteredBlock</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredMatrix">fetchFilteredMatrix</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#undoFilter">undoFilter</a></li></ul></li><li><a href="CellLabellingState.html">CellLabellingState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellLabellingState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#fetchResults">fetchResults</a></li></ul></li><li><a href="ChooseClusteringState.html">ChooseClusteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CombineEmbeddingsState.html">CombineEmbeddingsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchCombined">fetchCombined</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchNumberOfCells">fetchNumberOfCells</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchNumberOfDimensions">fetchNumberOfDimensions</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CrisprNormalizationState.html">CrisprNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="CrisprPcaState.html">CrisprPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CrisprQualityControlState.html">CrisprQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CustomSelectionsState.html">CustomSelectionsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#addSelection">addSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelectionIndices">fetchSelectionIndices</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelections">fetchSelections</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#removeSelection">removeSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#.computeVersusCustom">computeVersusCustom</a></li></ul></li><li><a href="FeatureSelectionState.html">FeatureSelectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchSortedResiduals">fetchSortedResiduals</a></li></ul></li><li><a href="FeatureSetEnrichmentState.html">FeatureSetEnrichmentState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchCollectionDetails">fetchCollectionDetails</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchFeatureSetIndices">fetchFeatureSetIndices</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchGroupResults">fetchGroupResults</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchPerCellScores">fetchPerCellScores</a></li></ul></li><li><a href="H5adDataset.html">H5adDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="H5adDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setCountMatrixName">setCountMatrixName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeColumnName">setFeatureTypeColumnName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="H5adResult.html">H5adResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="H5adResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setFeatureTypeColumnName">setFeatureTypeColumnName</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setPrimaryMatrixName">setPrimaryMatrixName</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#summary">summary</a></li></ul></li><li><a href="InputsState.html">InputsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InputsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#enableDatasetCache">enableDatasetCache</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchBlock">fetchBlock</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchBlockLevels">fetchBlockLevels</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchCellAnnotations">fetchCellAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchCountMatrix">fetchCountMatrix</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchDirectSubset">fetchDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchFeatureAnnotations">fetchFeatureAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchRowIds">fetchRowIds</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#setDirectSubset">setDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#undoSubset">undoSubset</a></li></ul></li><li><a href="KmeansClusterState.html">KmeansClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="MarkerDetectionState.html">MarkerDetectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#.computeVersusCustom">computeVersusCustom</a></li></ul></li><li><a href="NeighborIndexState.html">NeighborIndexState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#fetchIndex">fetchIndex</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="RnaNormalizationState.html">RnaNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="RnaPcaState.html">RnaPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="RnaPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="RnaQualityControlState.html">RnaQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="SimpleFile.html">SimpleFile</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SimpleFile.html#buffer">buffer</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#content">content</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#name">name</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#size">size</a></li></ul></li><li><a href="SnnGraphClusterState.html">SnnGraphClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="SummarizedExperimentDataset.html">SummarizedExperimentDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setAdtCountAssay">setAdtCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setAdtExperiment">setAdtExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setCrisprCountAssay">setCrisprCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setCrisprExperiment">setCrisprExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setRnaCountAssay">setRnaCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setRnaExperiment">setRnaExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="SummarizedExperimentResult.html">SummarizedExperimentResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setPrimaryAssay">setPrimaryAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#summary">summary</a></li></ul></li><li><a href="TenxHdf5Dataset.html">TenxHdf5Dataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="TenxMatrixMarketDataset.html">TenxMatrixMarketDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="TsneState.html">TsneState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TsneState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#fetchResults">fetchResults</a></li></ul></li><li><a href="UmapState.html">UmapState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UmapState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#fetchResults">fetchResults</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-DataFrame.html">external:DataFrame</a></li><li><a href="external-Dataset.html">external:Dataset</a></li><li><a href="external-ModelGeneVarResults.html">external:ModelGeneVarResults</a></li><li><a href="external-MultiMatrix.html">external:MultiMatrix</a></li><li><a href="external-PerCellAdtQcMetricsResults.html">external:PerCellAdtQcMetricsResults</a></li><li><a href="external-PerCellCrisprQcMetricsResults.html">external:PerCellCrisprQcMetricsResults</a></li><li><a href="external-PerCellRnaQcMetricsResults.html">external:PerCellRnaQcMetricsResults</a></li><li><a href="external-RunPCAResults.html">external:RunPCAResults</a></li><li><a href="external-ScoreMarkersResults.html">external:ScoreMarkersResults</a></li><li><a href="external-ScranMatrix.html">external:ScranMatrix</a></li><li><a href="external-SuggestAdtQcFiltersResults.html">external:SuggestAdtQcFiltersResults</a></li><li><a href="external-SuggestCrisprQcFiltersResults.html">external:SuggestCrisprQcFiltersResults</a></li><li><a href="external-SuggestRnaQcFiltersResults.html">external:SuggestRnaQcFiltersResults</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ArtifactDbProjectNavigator">ArtifactDbProjectNavigator</a></li><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#callScran">callScran</a></li><li><a href="global.html#configureApproximateNeighbors">configureApproximateNeighbors</a></li><li><a href="global.html#configureBatchCorrection">configureBatchCorrection</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#formatMarkerResults">formatMarkerResults</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#guessApproximateNeighborsConfig">guessApproximateNeighborsConfig</a></li><li><a href="global.html#guessBatchCorrectionConfig">guessBatchCorrectionConfig</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#promoteToNumber">promoteToNumber</a></li><li><a href="global.html#readLines2">readLines2</a></li><li><a href="global.html#readTable2">readTable2</a></li><li><a href="global.html#retrieveParameters">retrieveParameters</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveSingleCellExperiment">saveSingleCellExperiment</a></li><li><a href="global.html#serializeConfiguration">serializeConfiguration</a></li><li><a href="global.html#serializeDatasets">serializeDatasets</a></li><li><a href="global.html#setCellLabellingDownload">setCellLabellingDownload</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setFeatureSetEnrichmentDownload">setFeatureSetEnrichmentDownload</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setRnaQualityControlDownload">setRnaQualityControlDownload</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#subsetInputs">subsetInputs</a></li><li><a href="global.html#summarizeArray">summarizeArray</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#unserializeConfiguration">unserializeConfiguration</a></li><li><a href="global.html#unserializeDatasets">unserializeDatasets</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">readers/h5ad.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as scran from "scran.js";
import * as bioc from "bioconductor";
import * as eutils from "./utils/extract.js";
import * as futils from "./utils/features.js";
import * as afile from "./abstract/file.js";

/**************************
 ******* Internals ********
 **************************/

function fetch_assay_details(handle, path) {
    let available = [];
    if ("X" in handle.children) {
        available.push("X");
    } 

    if ("layers" in handle.children) {
        let lhandle = handle.open("layers");
        if (!(lhandle instanceof scran.H5Group)) {
            throw new Error("expected a 'layers' group in a H5AD file");
        }

        for (const k of Object.keys(lhandle.children)) {
            available.push("layers/" + k);
        }
    }

    if (available.length == 0) {
        throw new Error("failed to find any assay in the H5AD file");
    }

    let deets = scran.extractHDF5MatrixDetails(path, available[0]);
    return {
        names: available,
        rows: deets.rows,
        columns: deets.columns
    };
}

function load_data_frame(handle) {
    let columns = {};

    for (const [key, val] of Object.entries(handle.children)) {
        if (val == "DataSet") {
            let dhandle = handle.open(key, { load: true });
            columns[key] = dhandle.values;
        } else if (val == "Group") {
            // Factor encoding for H5AD versions >= 0.8.0.
            let subhandle = handle.open(key);
            if ("categories" in subhandle.children &amp;&amp; "codes" in subhandle.children) {
                let current_levels = eutils.extractHDF5Strings(subhandle, "categories");
                let codes = subhandle.open("codes", { load: true }).values;
                columns[key] = bioc.SLICE(current_levels, codes);
            }
        }
    }

    // Factor encoding for H5AD versions &lt; 0.8.0.
    if ("__categories" in handle.children &amp;&amp; handle.children["__categories"] == "Group") {
        let chandle = handle.open("__categories");

        for (const [key, val] of Object.entries(chandle.children)) {
            if (key in columns) {
                let current_levels = eutils.extractHDF5Strings(chandle, key);
                columns[key] = bioc.SLICE(current_levels, columns[key]);
            }
        }
    }

    if (Object.keys(columns).length == 0) {
        return null;
    } else {
        let rn = null;
        if ("_index" in columns) {
            rn = columns._index;
            delete columns._index;
        }
        return new bioc.DataFrame(columns, { rowNames: rn });
    }
}

function fetch_features(handle) {
    if ("var" in handle.children &amp;&amp; handle.children["var"] == "Group") {
        let vhandle = handle.open("var");
        return load_data_frame(vhandle);
    }
    return null;
}

function fetch_cells(handle) {
    if ("obs" in handle.children &amp;&amp; handle.children["obs"] == "Group") {
        let ohandle = handle.open("obs");
        return load_data_frame(ohandle);
    }
    return null;
}

/************************
 ******* Dataset ********
 ************************/

/**
 * Dataset in the H5AD format.
 */
export class H5adDataset {
    #h5_file;
    #h5_path;
    #h5_flush;
    #h5_handle;

    #raw_features;
    #raw_cells;
    #assay_details;

    #countMatrixName;
    #featureTypeColumnName;

    #featureTypeRnaName;
    #featureTypeAdtName;
    #featureTypeCrisprName;

    #primaryRnaFeatureIdColumn;
    #primaryAdtFeatureIdColumn;
    #primaryCrisprFeatureIdColumn;

    #dump_summary(fun) {
        let files = [{ type: "h5", file: fun(this.#h5_file) }]; 
        let options = {
            countMatrixName: this.#countMatrixName,
            featureTypeColumnName: this.#featureTypeColumnName,
            featureTypeRnaName: this.#featureTypeRnaName,
            featureTypeAdtName: this.#featureTypeAdtName,
            featureTypeCrisprName: this.#featureTypeCrisprName,
            primaryRnaFeatureIdColumn: this.#primaryRnaFeatureIdColumn,
            primaryAdtFeatureIdColumn: this.#primaryAdtFeatureIdColumn,
            primaryCrisprFeatureIdColumn: this.#primaryCrisprFeatureIdColumn
        };
        return { files, options };
    }

    /**
     * @param {SimpleFile|string|Uint8Array|File} h5File - Contents of a H5AD file.
     * On browsers, this may be a File object.
     * On Node.js, this may also be a string containing a file path.
     * @param {object} [options={}] - Optional parameters.
     * @param {?string} [options.countMatrixName=null] - See {@linkcode H5adDataset#setCountMatrixName setCountMatrixName}.
     * @param {?string} [options.featureTypeColumnName=null] - See {@linkcode H5adDataset#setFeatureTypeColumnName setFeatureTypeColumnName}.
     * @param {?string} [options.featureTypeRnaName="Gene Expression"] - See {@linkcode H5adDataset#setFeatureTypeRnaName setFeatureTypeRnaName}.
     * @param {?string} [options.featureTypeAdtName="Antibody Capture"] - See {@linkcode H5adDataset#setFeatureTypeAdtName setFeatureTypeAdtName}.
     * @param {?string} [options.featureTypeCrisprName="CRISPR Guide Capture"] - See {@linkcode H5adDataset#setFeatureTypeCrisprName setFeatureTypeCrisprName}.
     * @param {?(string|number)} [options.primaryRnaFeatureIdColumn=null] - See {@linkcode H5adDataset#setPrimaryRnaFeatureIdColumn setPrimaryRnaFeatureIdColumn}.
     * @param {?(string|number)} [options.primaryAdtFeatureIdColumn=null] - See {@linkcode H5adDataset#setPrimaryAdtFeatureIdColumn setPrimaryAdtFeatureIdColumn}.
     * @param {?(string|number)} [options.primaryCrisprFeatureIdColumn=null] - See {@linkcode H5adDataset#setPrimaryCrisprFeatureIdColumn setPrimaryCrisprFeatureIdColumn}.
     */
    constructor(h5File, { 
        countMatrixName = null, 
        featureTypeColumnName = null, 
        featureTypeRnaName = "Gene Expression", 
        featureTypeAdtName = "Antibody Capture", 
        featureTypeCrisprName = "CRISPR Guide Capture", 
        primaryRnaFeatureIdColumn = "_index", 
        primaryAdtFeatureIdColumn = "_index",
        primaryCrisprFeatureIdColumn = "_index" 
    } = {}) {
        if (h5File instanceof afile.SimpleFile) {
            this.#h5_file = h5File;
        } else {
            this.#h5_file = new afile.SimpleFile(h5File);
        }

        this.#countMatrixName = countMatrixName;
        this.#featureTypeColumnName = featureTypeColumnName;
        
        this.#featureTypeRnaName = featureTypeRnaName;
        this.#featureTypeAdtName = featureTypeAdtName;
        this.#featureTypeCrisprName = featureTypeCrisprName;

        this.#primaryRnaFeatureIdColumn = primaryRnaFeatureIdColumn;
        this.#primaryAdtFeatureIdColumn = primaryAdtFeatureIdColumn;
        this.#primaryCrisprFeatureIdColumn = primaryCrisprFeatureIdColumn;

        this.clear();
    }

    /**
     * @param {?string} name - Name of the layer containing the count matrix.
     * If `null`, the "X" dataset is used if it is present in the file, or the first available layer if no "X" dataset is present.
     */
    setCountMatrixName(name) {
        this.#countMatrixName = name;
        return;
    }

    /**
     * @param {?string} name - Name of the per-feature annotation column containing the feature types.
     * If `null`, no column is assumed to contain the feature types, and all features are assumed to be genes (i.e., only the RNA modality is present).
     */
    setFeatureTypeColumnName(name) {
        this.#featureTypeColumnName = name;
        return;
    }

    /**
     * @param {?string} name - Name of the feature type for gene expression.
     * Alternatively `null`, to indicate that no RNA features are to be loaded.
     */
    setFeatureTypeRnaName(name) {
        this.#featureTypeRnaName = name;
        return;
    }

    /**
     * @param {string} name - Name of the feature type for ADTs.
     * Alternatively `null`, to indicate that no ADT features are to be loaded.
     */
    setFeatureTypeAdtName(name) {
        this.#featureTypeAdtName = name;
        return;
    }

    /**
     * @param {?string} name - Name of the feature type for CRISPR guides.
     * Alternatively `null`, to indicate that no guides are to be loaded.
     */
    setFeatureTypeCrisprName(name) {
        this.#featureTypeCrisprName = name;
        return;
    }

    /**
     * @param {?(string|number)} i - Name or index of the column of the `features` {@linkplain external:DataFrame DataFrame} that contains the primary feature identifier for gene expression.
     *
     * If `i` is `null` or invalid (e.g., out of range index, unavailable name), it is ignored and the row names (from the `_index` group) are used as the primary identifiers.
     * If no row names are present in this situation, no primary identifier is defined.
     */
    setPrimaryRnaFeatureIdColumn(i) {
        this.#primaryRnaFeatureIdColumn = i;
        return;
    }

    /**
     * @param {?(string|number)} i - Name or index of the column of the `features` {@linkplain external:DataFrame DataFrame} that contains the primary feature identifier for the ADTs.
     *
     * If `i` is `null` or invalid (e.g., out of range index, unavailable name), it is ignored and the row names (from the `_index` group) are used as the primary identifiers.
     * If no row names are present in this situation, no primary identifier is defined.
     */
    setPrimaryAdtFeatureIdColumn(i) {
        this.#primaryAdtFeatureIdColumn = i;
        return;
    }

    /**
     * @param {?(string|number)} i - Name or index of the column of the `features` {@linkplain external:DataFrame DataFrame} that contains the primary feature identifier for the CRISPR guides.
     *
     * If `i` is `null` or invalid (e.g., out of range index, unavailable name), it is ignored and the row names (from the `_index` group) are used as the primary identifiers.
     * If no row names are present in this situation, no primary identifier is defined.
     */
    setPrimaryCrisprFeatureIdColumn(i) {
        this.#primaryCrisprFeatureIdColumn = i;
        return;
    }

    #instantiate() {
        if (this.#h5_path != null) {
            return;
        }

        let info = scran.realizeFile(this.#h5_file.content());
        this.#h5_path = info.path;
        this.#h5_flush = info.flush;
        this.#h5_handle = new scran.H5File(this.#h5_path);
    }

    /**
     * Destroy caches if present, releasing the associated memory. 
     * This may be called at any time but only has an effect if `cache = true` in {@linkcode H5adDataset#load load} or {@linkcodeH5adDataset#summary summary}.
     */
    clear() {
        if (typeof this.#h5_flush == "function") {
            this.#h5_flush();
        }
        this.#h5_flush = null;
        this.#h5_path = null;
        this.#h5_handle = null;

        this.#raw_features = null;
        this.#raw_cells = null;
        this.#assay_details = null;
    }

    /**
     * @return {string} Format of this dataset class.
     * @static
     */
    static format() {
        return "H5AD";
    }

    /**
     * @return {object} Object containing the abbreviated details of this dataset.
     */
    abbreviate() {
        return this.#dump_summary(f => { return { name: f.name(), size: f.size() }; });
    }

    #fetch_assay_details() {
        if (this.#assay_details !== null) {
            return;
        }
        this.#instantiate();
        this.#assay_details = fetch_assay_details(this.#h5_handle, this.#h5_path);
    }

    #features() {
        if (this.#raw_features !== null) {
            return;
        }
        this.#instantiate();

        let feats = fetch_features(this.#h5_handle);
        if (feats == null) {
            this.#fetch_assay_details();
            feats = new bioc.DataFrame({}, { numberOfRows: this.#assay_details.rows });
        }

        this.#raw_features = feats;
        return;
    }

    #cells() {
        if (this.#raw_cells !== null) {
            return;
        }
        this.#instantiate();

        let cells = fetch_cells(this.#h5_handle);
        if (cells === null) {
            this.#fetch_assay_details();
            cells = new bioc.DataFrame({}, { numberOfRows: this.#assay_details.columns })
        }

        this.#raw_cells = cells;
        return;
    }

    /**
     * @param {object} [options={}] - Optional parameters.
     * @param {boolean} [options.cache=false] - Whether to cache the results for re-use in subsequent calls to this method or {@linkcode H5adDataset#load load}.
     * If `true`, users should consider calling {@linkcode H5adDataset#clear clear} to release the memory once this dataset instance is no longer needed.
     *
     * @return {object} Object containing the per-feature and per-cell annotations.
     * This has the following properties:
     *
     * - `all_features`: a {@linkplain external:DataFrame DataFrame} of per-feature annotations.
     * - `cells`: a {@linkplain external:DataFrame DataFrame} of per-cell annotations.
     * - `all_assay_names`: an Array of strings containing names of potential count matrices.
     */
    summary({ cache = false } = {}) {
        this.#features();
        this.#cells();
        this.#fetch_assay_details();

        let output = {
            all_features: this.#raw_features,
            cells: this.#raw_cells,
            all_assay_names: this.#assay_details.names
        };

        if (!cache) {
            this.clear();
        }
        return output;
    }

    /**
     * @param {object} [options={}] - Optional parameters.
     * @param {boolean} [options.cache=false] - Whether to cache the results for re-use in subsequent calls to this method or {@linkcode H5adDataset#summary summary}.
     * If `true`, users should consider calling {@linkcode H5adDataset#clear clear} to release the memory once this dataset instance is no longer needed.
     *
     * @return {object} Object containing the per-feature and per-cell annotations.
     * This has the following properties:
     *
     * - `features`: an object where each key is a modality name and each value is a {@linkplain external:DataFrame DataFrame} of per-feature annotations for that modality.
     * - `cells`: a {@linkplain external:DataFrame DataFrame} containing per-cell annotations.
     * - `matrix`: a {@linkplain external:MultiMatrix MultiMatrix} containing one {@linkplain external:ScranMatrix ScranMatrix} per modality.
     * - `primary_ids`: an object where each key is a modality name and each value is an array of strings containing the feature identifiers for each row in that modality.
     *
     * Modality names are guaranteed to be one of `"RNA"` or `"ADT"`.
     * It is assumed that an appropriate mapping from the feature types inside the `featureFile` was previously declared,
     * either in the constructor or in {@linkcode setFeatureTypeRnaName} and {@linkcode setFeatureTypeAdtName}.
     */
    load({ cache = false } = {}) {
        this.#features();
        this.#cells();
        this.#fetch_assay_details();

        let chosen_assay = this.#countMatrixName;
        if (chosen_assay == null) {
            chosen_assay = this.#assay_details.names[0];
        }
        let loaded = scran.initializeSparseMatrixFromHDF5(this.#h5_path, chosen_assay);

        let mappings = { 
            RNA: this.#featureTypeRnaName, 
            ADT: this.#featureTypeAdtName,
            CRISPR: this.#featureTypeCrisprName
        };
        let output = futils.splitScranMatrixAndFeatures(loaded, this.#raw_features, this.#featureTypeColumnName, mappings, "RNA");
        output.cells = this.#raw_cells;

        let primaries = { 
            RNA: this.#primaryRnaFeatureIdColumn, 
            ADT: this.#primaryAdtFeatureIdColumn,
            CRISPR: this.#primaryCrisprFeatureIdColumn
        };
        output.primary_ids = futils.extractPrimaryIds(output.features, primaries);

        if (!cache) {
            this.clear();
        }
        return output;
    }

    /**
     * @return {object} Object describing this dataset, containing:
     *
     * - `files`: Array of objects representing the files used in this dataset.
     *   Each object corresponds to a single file and contains:
     *   - `type`: a string denoting the type.
     *   - `file`: a {@linkplain SimpleFile} object representing the file contents.
     * - `options`: An object containing additional options to saved.
     */
    serialize() {
        return this.#dump_summary(f => f);
    }

    /**
     * @param {Array} files - Array of objects like that produced by {@linkcode H5adDataset#serialize serialize}.
     * @param {object} options - Object containing additional options to be passed to the constructor.
     * @return {H5adDataset} A new instance of this class.
     * @static
     */
    static async unserialize(files, options) {
        if (files.length != 1 || files[0].type != "h5") {
            throw new Error("expected exactly one file of type 'h5' for H5AD unserialization");
        }
        return new H5adDataset(files[0].file, options);
    }
}

/************************
 ******* Results ********
 ************************/

/**
 * Pre-computed analysis results in the H5AD format.
 */
export class H5adResult {
    #h5_file;
    #h5_path;
    #h5_flush;
    #h5_handle;

    #raw_features;
    #raw_cells;
    #assay_details;
    #reddim_details;

    #primaryMatrixName;
    #isPrimaryNormalized;
    #featureTypeColumnName;
    #reducedDimensionNames;

    /**
     * @param {SimpleFile|string|Uint8Array|File} h5File - Contents of a H5AD file.
     * On browsers, this may be a File object.
     * On Node.js, this may also be a string containing a file path.
     * @param {object} [options={}] - Optional parameters.
     * @param {?string} [options.primaryMatrixName=null] - See {@linkcode H5adResult#setPrimaryMatrixName setPrimaryMatrixName}.
     * @param {boolean} [options.isPrimaryNormalized=true] - See {@linkcode H5adResult#setIsPrimaryNormalized setIsPrimaryNormalized}.
     * @param {?string} [options.featureTypeColumnName=null] - See {@linkcode H5adResult#setFeatureTypeColumnName setFeatureTypeColumnName}.
     * @param {?Array} [options.reducedDimensionNames=null] - See {@linkcode H5adResult#setReducedDimensionNames setReducedDimensionNames}.
     */
    constructor(h5File, { 
        primaryMatrixName = null, 
        isPrimaryNormalized=true,
        featureTypeColumnName = null, 
        reducedDimensionNames = null
    } = {}) {
        if (h5File instanceof afile.SimpleFile) {
            this.#h5_file = h5File;
        } else {
            this.#h5_file = new afile.SimpleFile(h5File);
        }

        this.#primaryMatrixName = primaryMatrixName;
        this.#isPrimaryNormalized = isPrimaryNormalized;
        this.#featureTypeColumnName = featureTypeColumnName;
        this.#reducedDimensionNames = reducedDimensionNames;

        this.clear();
    }

    /**
     * Destroy caches if present, releasing the associated memory. 
     * This may be called at any time but only has an effect if `cache = true` in {@linkcode H5adResult#load load} or {@linkcodeH5adResult#summary summary}.
     */
    clear() {
        if (typeof this.#h5_flush == "function") {
            this.#h5_flush();
        }
        this.#h5_flush = null;
        this.#h5_path = null;
        this.#h5_handle = null;

        this.#raw_features = null;
        this.#raw_cells = null;
        this.#assay_details = null;
        this.#reddim_details = null;
    }

    /**
     * @param {?string} name - Name of the layer containing the primary matrix.
     * If `null`, the "X" dataset is used if it is present in the file, or the first available layer if no "X" dataset is present.
     */
    setPrimaryMatrixName(name) {
        this.#primaryMatrixName = name;
        return;
    }

    /**
     * @param {boolean} normalized - Whether the primary matrix is already normalized.
     * If `false`, it is assumed to contain count data and is subjected to library size normalization within each modality.
     */
    setIsPrimaryNormalized(normalized) {
        this.#isPrimaryNormalized = normalized;
    }

    /**
     * @param {?string} name - Name of the per-feature annotation column containing the feature types.
     * If `null`, no column is assumed to contain the feature types, and all features are assumed to be genes (i.e., only the RNA modality is present).
     */
    setFeatureTypeColumnName(name) {
        this.#featureTypeColumnName = name;
        return;
    }

    /**
     * @param {?Array} names - Array of names of the reduced dimensions to load.
     * If `null`, all reduced dimensions found in the file are loaded.
     */
    setReducedDimensionNames(names) {
        this.#reducedDimensionNames = names;
        return;
    }

    #instantiate() {
        if (this.#h5_path != null) {
            return;
        }

        let info = scran.realizeFile(this.#h5_file.content());
        this.#h5_path = info.path;
        this.#h5_flush = info.flush;
        this.#h5_handle = new scran.H5File(this.#h5_path);
    }

    #fetch_assay_details() {
        if (this.#assay_details !== null) {
            return;
        }
        this.#instantiate();
        this.#assay_details = fetch_assay_details(this.#h5_handle, this.#h5_path);
        return;
    }

    #features() {
        if (this.#raw_features !== null) {
            return;
        }
        this.#instantiate();

        let feats = fetch_features(this.#h5_handle);
        if (feats == null) {
            this.#fetch_assay_details();
            feats = new bioc.DataFrame({}, { numberOfRows: this.#assay_details.rows });
        }

        this.#raw_features = feats;
        return;
    }

    #cells() {
        if (this.#raw_cells !== null) {
            return;
        }
        this.#instantiate();

        let cells = fetch_cells(this.#h5_handle);
        if (cells === null) {
            this.#fetch_assay_details();
            cells = new bioc.DataFrame({}, { numberOfRows: this.#assay_details.columns })
        }

        this.#raw_cells = cells;
        return;
    }

    #fetch_reddim_details() {
        if (this.#reddim_details !== null) {
            return;
        }
        this.#instantiate();
        
        let available = [];
        if ("obsm" in this.#h5_handle.children &amp;&amp; this.#h5_handle.children["obsm"] == "Group") {
            let ohandle = this.#h5_handle.open("obsm");
            for (const [k, v] of Object.entries(ohandle.children)) {
                if (v == "DataSet") {
                    available.push(k);
                }
            }
        }

        this.#reddim_details = { names: available };
        return;
    }

    /**
     * @param {object} [options={}] - Optional parameters.
     * @param {boolean} [options.cache=false] - Whether to cache the results for re-use in subsequent calls to this method or {@linkcode H5adDataset#load load}.
     * If `true`, users should consider calling {@linkcode H5adDataset#clear clear} to release the memory once this dataset instance is no longer needed.
     *
     * @return {object} Object containing the per-feature and per-cell annotations.
     * This has the following properties:
     *
     * - `all_features`: a {@linkplain external:DataFrame DataFrame} of per-feature annotations.
     * - `cells`: a {@linkplain external:DataFrame DataFrame} of per-cell annotations.
     * - `all_assay_names`: an Array of strings containing names of potential primary matrices.
     * - `reduced_dimension_names`: an Array of strings containing names of dimensionality reduction results.
     */
    summary({ cache = false } = {}) {
        this.#features();
        this.#cells();
        this.#fetch_assay_details();
        this.#fetch_reddim_details();

        let output = {
            all_features: this.#raw_features,
            cells: this.#raw_cells,
            all_assay_names: this.#assay_details.names,
            reduced_dimension_names: this.#reddim_details.names
        };

        if (!cache) {
            this.clear();
        }
        return output;
    }

    /**
     * @param {object} [options={}] - Optional parameters.
     * @param {boolean} [options.cache=false] - Whether to cache the results for re-use in subsequent calls to this method or {@linkcode H5adResult#summary summary}.
     * If `true`, users should consider calling {@linkcode H5adResult#clear clear} to release the memory once this dataset instance is no longer needed.
     *
     * @return {object} Object containing the per-feature and per-cell annotations.
     * This has the following properties:
     *
     * - `features`: an object where each key is a modality name and each value is a {@linkplain external:DataFrame DataFrame} of per-feature annotations for that modality.
     * - `cells`: a {@linkplain external:DataFrame DataFrame} containing per-cell annotations.
     * - `matrix`: a {@linkplain external:MultiMatrix MultiMatrix} containing one {@linkplain external:ScranMatrix ScranMatrix} per modality.
     * - `reduced_dimensions`: an object containing the dimensionality reduction results.
     *   Each value is an array of arrays, where each inner array contains the coordinates for one dimension.
     */
    load({ cache = false } = {}) {
        this.#features();
        this.#cells();
        this.#fetch_assay_details();
        this.#fetch_reddim_details();

        let chosen_assay = this.#primaryMatrixName;
        if (chosen_assay == null) {
            chosen_assay = this.#assay_details.names[0];
        }
        let loaded = scran.initializeSparseMatrixFromHDF5(this.#h5_path, chosen_assay, { forceInteger: !this.#isPrimaryNormalized });
        let output = futils.splitScranMatrixAndFeatures(loaded, this.#raw_features, this.#featureTypeColumnName, null, "");
        output.cells = this.#raw_cells;
        delete output.row_ids;

        if (!this.#isPrimaryNormalized) {
            for (const mod of output.matrix.available()) {
                let mat = output.matrix.get(mod);
                output.matrix.add(mod, scran.logNormCounts(mat, { allowZeros: true }));
            }
        }

        // Loading the dimensionality reduction results.
        let chosen_reddims = this.#reducedDimensionNames;
        if (chosen_reddims == null) {
            chosen_reddims = this.#reddim_details.names;
        }

        let reddims = {};
        if (chosen_reddims.length) {
            let ohandle = this.#h5_handle.open("obsm");
            for (const k of chosen_reddims) {
                let loaded = ohandle.open(k, { load: true });
                let shape = loaded.shape;
                let ndims = shape[1];
                let ncells = shape[0];

                let contents = [];
                for (var d = 0; d &lt; ndims; d++) {
                    contents.push(new Float64Array(ncells));
                }

                for (var c = 0; c &lt; ncells; c++) {
                    for (var d = 0; d &lt; ndims; d++) {
                        contents[d][c] = loaded.values[c * ndims + d];
                    }
                }

                reddims[k] = contents;
            }
        }
        output.reduced_dimensions = reddims;
        
        if (!cache) {
            this.clear();
        }
        return output;
    }

}

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Wed Feb 22 2023 06:53:33 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
