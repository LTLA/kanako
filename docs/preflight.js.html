<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>preflight.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/LTLA/bakana" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AdtNormalizationState.html">AdtNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchExpression">fetchExpression</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#summary">summary</a></li></ul></li><li><a href="AdtPcaState.html">AdtPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#summary">summary</a></li></ul></li><li><a href="AdtQualityControlState.html">AdtQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#summary">summary</a></li></ul></li><li><a href="BatchCorrectionState.html">BatchCorrectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#compute">compute</a></li></ul></li><li><a href="CellFilteringState.html">CellFilteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellFilteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredAnnotations">fetchFilteredAnnotations</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredBlock">fetchFilteredBlock</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#undoFiltering">undoFiltering</a></li></ul></li><li><a href="CellLabellingState.html">CellLabellingState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellLabellingState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#summary">summary</a></li></ul></li><li><a href="ChooseClusteringState.html">ChooseClusteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchClusterIndices">fetchClusterIndices</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#summary">summary</a></li></ul></li><li><a href="CombineEmbeddingsState.html">CombineEmbeddingsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#compute">compute</a></li></ul></li><li><a href="CustomSelectionsState.html">CustomSelectionsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#.computeVersusCustom">computeVersusCustom</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#addSelection">addSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelectionIndices">fetchSelectionIndices</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelections">fetchSelections</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#removeSelection">removeSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#summary">summary</a></li></ul></li><li><a href="FeatureSelectionState.html">FeatureSelectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#summary">summary</a></li></ul></li><li><a href="H5adDataset.html">H5adDataset</a></li><li><a href="InputsState.html">InputsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InputsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchAnnotations">fetchAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#setDirectSubset">setDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#undoSubset">undoSubset</a></li></ul></li><li><a href="KmeansClusterState.html">KmeansClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#summary">summary</a></li></ul></li><li><a href="MarkerDetectionState.html">MarkerDetectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#.computeVersusCustom">computeVersusCustom</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchGroupResults">fetchGroupResults</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#numberOfGroups">numberOfGroups</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#summary">summary</a></li></ul></li><li><a href="NeighborIndexState.html">NeighborIndexState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#summary">summary</a></li></ul></li><li><a href="NormalizationState.html">NormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NormalizationState.html#fetchExpression">fetchExpression</a></li><li data-type='method' style='display: none;'><a href="NormalizationState.html#summary">summary</a></li></ul></li><li><a href="PcaState.html">PcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="PcaState.html#summary">summary</a></li></ul></li><li><a href="QualityControlState.html">QualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="QualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="QualityControlState.html#summary">summary</a></li></ul></li><li><a href="SimpleFile.html">SimpleFile</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SimpleFile.html#buffer">buffer</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#content">content</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#name">name</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#size">size</a></li></ul></li><li><a href="SnnGraphClusterState.html">SnnGraphClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#summary">summary</a></li></ul></li><li><a href="SummarizedExperimentDataset.html">SummarizedExperimentDataset</a></li><li><a href="TenxHdf5Dataset.html">TenxHdf5Dataset</a></li><li><a href="TenxMatrixMarketDataset.html">TenxMatrixMarketDataset</a></li><li><a href="TsneState.html">TsneState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TsneState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#summary">summary</a></li></ul></li><li><a href="UmapState.html">UmapState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UmapState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#summary">summary</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-DataFrame.html">external:DataFrame</a></li><li><a href="external-Dataset.html">external:Dataset</a></li><li><a href="external-ScranMatrix.html">external:ScranMatrix</a></li></ul><h3>Global</h3><ul><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#callScran">callScran</a></li><li><a href="global.html#configureApproximateNeighbors">configureApproximateNeighbors</a></li><li><a href="global.html#configureBatchCorrection">configureBatchCorrection</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#createKanaFile">createKanaFile</a></li><li><a href="global.html#formatMarkerResults">formatMarkerResults</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#guessApproximateNeighborsConfig">guessApproximateNeighborsConfig</a></li><li><a href="global.html#guessBatchCorrectionConfig">guessBatchCorrectionConfig</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#kanaFormatVersion">kanaFormatVersion</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#promoteToNumber">promoteToNumber</a></li><li><a href="global.html#readLines">readLines</a></li><li><a href="global.html#readTable">readTable</a></li><li><a href="global.html#retrieveParameters">retrieveParameters</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveAnalysis">saveAnalysis</a></li><li><a href="global.html#setCellLabellingDownload">setCellLabellingDownload</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#subsetInputs">subsetInputs</a></li><li><a href="global.html#summarizeArray">summarizeArray</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#unpackText">unpackText</a></li><li><a href="global.html#validateAnnotations">validateAnnotations</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">preflight.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as rutils from "./readers/index.js";
import * as iutils from "./steps/inputs.js";

/**
 * Perform preflight validation of the annotations in the input datasets.
 *
 * This is usually done in regards to the consistency of gene annotations for multiple datasets.
 * If multiple datasets are present, an error is raised if any matrix does not contain gene annotations;
 * or there is no common species and feature type for annotations across all datasets;
 * or the intersection of genes is empty.
 *
 * @param {object} datasets - An object where each key is the name of a dataset and each property is a {@linkplain Dataset}.
 * See the argument of the same name in {@linkcode runAnalysis} for more details.
 *
 * @return {object} An object containing preflight check information for the `annotations` and `features`.
 *
 * `annotations` is an object where each property corresponds to an input matrix in `datasets`.
 * Each element is itself an object describing the cell annotation fields in the corresponding matrix.
 * Each key of the inner object contains the name of an annotation field, while each value is an object summarizing that annotation.
 * Each annotation summary contains:
 *   - a `type` property, indicating whether the annotation is `"categorical"` or "`continuous"`.
 *   - for categorical annotations, a `values` array containing the unique values.
 *     This may be truncated for brevity, in which case the `truncated` property is `true`.
 *   - for continuous annotations, the `min` and `max` properties containing the minimum and maximum values.
 *
 * `features` is an object where each key is the name of a modality (e.g., `"RNA"`, `"ADT"`) and the property is another object.
 * Each inner object contains:
 * - `common`: an integer containing the number of common genes across all datasets.
 *    This may be `null` if `datasets` has only a single entry that lacks gene annotation.
 * - `fields`: an object where each property corresponds to an input matrix in `datasets`.
 *    Each property is a string containing the name of the gene annotation field that was chosen for the intersection in the corresponding matrix.
 *    This may be `null` if `datasets` has only a single entry that lacks gene annotation.
 *
 * @async
 */
export async function validateAnnotations(datasets) {
    let mkeys = Object.keys(datasets);
    let multi = mkeys.length > 1;

    let promises = [];
    for (const key of mkeys) {
        promises.push(datasets[key].annotations());
    }
    let collected = await Promise.all(promises);

    let annotations = {};
    for (const [i, key] of Object.entries(mkeys)) {
        annotations[key] = collected[i].cells.summary;
    }

    let modal_mappings = iutils.guessDefaultModalities(collected);
    if (Object.keys(modal_mappings).length == 0) {
        throw new Error("failed to find any common modalities");
    }

    // For each modality, intersect the features.
    let feature_info = {};
    
    for (const [m, chosen] of Object.entries(modal_mappings)) {
        feature_info[m] = { fields: {} };

        let genes2 = [];
        for (var i = 0; i &lt; collected.length; i++) {
            genes2.push(collected[i].features[chosen[i]]);
        }

        let results = iutils.commonFeatureTypes(genes2);

        if (multi) {
            if (results.best_type === null) {
                throw new Error("cannot find common feature types across all datasets");
            }
            for (var i = 0; i &lt; collected.length; i++) {
                feature_info[m].fields[mkeys[i]] = results.best_fields[i];
            }

            let intersection = null;
            for (const [k, v] of Object.entries(results.best_fields)) {
                let curgenes = genes2[k].column(v);
                if (intersection === null) {
                    intersection = curgenes;
                } else {
                    let dset = new Set(curgenes);
                    intersection = intersection.filter(n => dset.has(n));
                }
            }
            feature_info[m].common = intersection.length;
        } else {
            let cn = genes2[0].columnNames();
            feature_info[m].fields[mkeys[0]] = (cn.length ? cn[0] : "");
            feature_info[m].common = genes2[0].numberOfRows();
        }
    }

    return { 
        annotations: annotations,
        features: feature_info
    };
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Oct 31 2022 16:34:44 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
