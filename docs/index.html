<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Home - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/LTLA/bakana" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AdtNormalizationState.html">AdtNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchExpression">fetchExpression</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#summary">summary</a></li></ul></li><li><a href="AdtPcaState.html">AdtPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#summary">summary</a></li></ul></li><li><a href="AdtQualityControlState.html">AdtQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#summary">summary</a></li></ul></li><li><a href="BatchCorrectionState.html">BatchCorrectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#compute">compute</a></li></ul></li><li><a href="CellFilteringState.html">CellFilteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellFilteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredAnnotations">fetchFilteredAnnotations</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredBlock">fetchFilteredBlock</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#undoFiltering">undoFiltering</a></li></ul></li><li><a href="CellLabellingState.html">CellLabellingState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellLabellingState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#summary">summary</a></li></ul></li><li><a href="ChooseClusteringState.html">ChooseClusteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchClusterIndices">fetchClusterIndices</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#summary">summary</a></li></ul></li><li><a href="CombineEmbeddingsState.html">CombineEmbeddingsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#compute">compute</a></li></ul></li><li><a href="CustomSelectionsState.html">CustomSelectionsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#addSelection">addSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelectionIndices">fetchSelectionIndices</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelections">fetchSelections</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#removeSelection">removeSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#summary">summary</a></li></ul></li><li><a href="FeatureSelectionState.html">FeatureSelectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#summary">summary</a></li></ul></li><li><a href="InputsState.html">InputsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InputsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchAnnotations">fetchAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#setDirectSubset">setDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#undoSubset">undoSubset</a></li></ul></li><li><a href="KmeansClusterState.html">KmeansClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#summary">summary</a></li></ul></li><li><a href="MarkerDetectionState.html">MarkerDetectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchGroupResults">fetchGroupResults</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#numberOfGroups">numberOfGroups</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#summary">summary</a></li></ul></li><li><a href="NeighborIndexState.html">NeighborIndexState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#summary">summary</a></li></ul></li><li><a href="NormalizationState.html">NormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NormalizationState.html#fetchExpression">fetchExpression</a></li><li data-type='method' style='display: none;'><a href="NormalizationState.html#summary">summary</a></li></ul></li><li><a href="PcaState.html">PcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="PcaState.html#summary">summary</a></li></ul></li><li><a href="QualityControlState.html">QualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="QualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="QualityControlState.html#summary">summary</a></li></ul></li><li><a href="SnnGraphClusterState.html">SnnGraphClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#summary">summary</a></li></ul></li><li><a href="TsneState.html">TsneState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TsneState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#summary">summary</a></li></ul></li><li><a href="UmapState.html">UmapState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UmapState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#summary">summary</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#callScran">callScran</a></li><li><a href="global.html#configureApproximateNeighbors">configureApproximateNeighbors</a></li><li><a href="global.html#configureBatchCorrection">configureBatchCorrection</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#createKanaFile">createKanaFile</a></li><li><a href="global.html#createKanaFileInternal">createKanaFileInternal</a></li><li><a href="global.html#createTsneWorker">createTsneWorker</a></li><li><a href="global.html#formatMarkerResults">formatMarkerResults</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#guessApproximateNeighborsConfig">guessApproximateNeighborsConfig</a></li><li><a href="global.html#guessBatchCorrectionConfig">guessBatchCorrectionConfig</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#kanaFormatVersion">kanaFormatVersion</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#promoteToNumber">promoteToNumber</a></li><li><a href="global.html#readLines">readLines</a></li><li><a href="global.html#readTable">readTable</a></li><li><a href="global.html#removeHDF5File">removeHDF5File</a></li><li><a href="global.html#retrieveParameters">retrieveParameters</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveAnalysis">saveAnalysis</a></li><li><a href="global.html#setCellLabellingDownload">setCellLabellingDownload</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#subsetInputs">subsetInputs</a></li><li><a href="global.html#summarizeArray">summarizeArray</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#unpackText">unpackText</a></li><li><a href="global.html#validateAnnotations">validateAnnotations</a></li></ul>
</nav>

<div id="main">
    

    



    


    <section class="package">
        <h3> </h3>		
    </section>









    



    <section class="readme usertext">
        <article><h1>Backend for kana</h1>
<h2>Overview</h2>
<p><strong>bakana</strong> provides the compute backend for the <a href="https://github.com/jkanche/kana"><strong>kana</strong></a> application.
It provides a pipeline for a routine single-cell RNA-seq analysis, starting from the count matrix and finishing with the usual results (markers, clusters, t-SNE and so on).
Datasets involving multiple samples in one or multiple matrices can also be analyzed with blocking and batch correction.
The pipeline can be executed both in the browser and on Node.js.
It supports in-memory caching of the analysis state for fast iterative re-analysis,
as well as serialization of the state for storage and distribution to other machines.</p>
<h2>Getting started</h2>
<p>Install the package from <a href="https://npmjs.com/package/bakana">NPM</a> using the usual method:</p>
<pre class="prettyprint source lang-sh"><code>npm install bakana
</code></pre>
<p>See the <a href="https://ltla.github.io/bakana/">reference documentation</a> for details on available functions.</p>
<h2>Running analyses</h2>
<p>We perform an analysis with the following commands:</p>
<pre class="prettyprint source lang-js"><code>import * as bakana from &quot;bakana&quot;;
await bakana.initialize({ numberOfThreads: 8 });

let state = await bakana.createAnalysis();
let params = bakana.analysisDefaults();

await bakana.runAnalysis(state, 
    // Specify files using paths (Node.js) or File objects (browser).
    { my_data: { format: &quot;10X&quot;, h5: &quot;/some/file/path&quot; } },
    params
);
</code></pre>
<p>Each step is represented by a <code>*State</code> class instance as a property of <code>state</code>, containing the analysis results.
We can extract summaries for diagnostics or display on a UI:</p>
<pre class="prettyprint source lang-js"><code>state.quality_control.summary();
// {
//   data: {
//     default: {
//       sums: [Float64Array],
//       detected: [Int32Array],
//       proportion: [Float64Array]
//     }
//   },
//   ...
// }

state.pca.summary():
// {
//   var_exp: Float64Array(20) [...]
// }

// Some summary() are promises, see the relevant documentation.
await state.tsne.summary();
// {
//   x: [Float64Array],
//   y: [Float64Array],
//   iterations: 500
// }
</code></pre>
<p>Alternatively, we can supply a callback that processes summaries from each step as soon as it finishes.
This can be useful for, e.g., posting diagnostics to another system once they become available.</p>
<pre class="prettyprint source lang-js"><code>function finisher(step, results) {
    console.log(step);
    // Do other stuff with 'results' here.
}

await bakana.runAnalysis(state, 
    // Specify files using paths (Node.js) or File objects (browser).
    { my_data: { format: &quot;10X&quot;, h5: &quot;/some/file/path&quot; } },
    params,
    { finishFun: finisher }
);
// inputs
// quality_control
// normalizaton
// feature_selection
// pca
// neighbor_index
// kmeans_cluster
// ...
</code></pre>
<p>If the analysis is re-run with different parameters, <strong>bakana</strong> will only re-run the affected steps.
This includes all steps downstream of any step with changed parameters.</p>
<pre class="prettyprint source lang-js"><code>params.pca.num_pcs = 15;

await bakana.runAnalysis(state, 
    // Specify files using paths (Node.js) or File objects (browser).
    { my_data: { format: &quot;10X&quot;, h5: &quot;/some/file/path&quot; } },
    params,
    { finishFun: finisher }
);
// pca
// neighbor_index
// ...
</code></pre>
<h2>Saving analyses</h2>
<p>Given an analysis state, we can save the parameters and results to a HDF5 file.</p>
<pre class="prettyprint source lang-js"><code>let collected = await bakana.saveAnalysis(state, &quot;whee.h5&quot;);
</code></pre>
<p><code>saveAnalysis</code> will return a promise that resolves to an array of paths (Node.js) or <code>File</code> objects for the original data files.
These can be used to assemble a <code>*.kana</code>-format file following the <a href="https://ltla.github.io/kanaval"><strong>kanaval</strong> specification</a>.
By default, this assumes that we are embedding the data files into the <code>*.kana</code> file.</p>
<pre class="prettyprint source lang-js"><code>let res = await bakana.createKanaFile(&quot;whee.h5&quot;, collected.collected);
</code></pre>
<p>Advanced users may prefer to store links to the data files rather than embedding them.
This can be achieved using the <code>setCreateLink()</code> function to define a mechanism for creating application-specific links.
For example, the <strong>kana</strong> application uses IndexedDB to cache each file for later use in the browser.</p>
<pre class="prettyprint source lang-js"><code>bakana.setCreateLink(save_to_some_db);
bakana.setResolveLink(load_from_some_db);
</code></pre>
<h2>Loading analyses</h2>
<p>Given a <code>*.kana</code> file, it is straightforward to extract the various state and data files.</p>
<pre class="prettyprint source lang-js"><code>let loader = await bakana.parseKanaFile(&quot;something.kana&quot;, &quot;foo.h5&quot;);
</code></pre>
<p>Once the <code>*.kana</code> file is parsed, we can reload the analysis state into memory.
We can also report the parameters used at each step.</p>
<pre class="prettyprint source lang-js"><code>let reloaded = await bakana.loadAnalysis(&quot;foo.h5&quot;, loader);
let params = bakana.retrieveParameters(reloaded);
</code></pre>
<p>These can be used to perform a new analysis, possibly after modifying some parameters.</p>
<pre class="prettyprint source lang-js"><code>params.pca.num_hvgs = 3000;
await bakana.runAnalysis(new_state, null, new_params);
</code></pre>
<p>Again, we can supply a callback that runs on the results of each step as soon as they are loaded.</p>
<pre class="prettyprint source lang-js"><code>let reloaded = await bakana.loadAnalysis(&quot;whee.h5&quot;, loader, { finishFun: finisher });
</code></pre>
<p>If links are present, it is assumed that the application will use <code>setResolveLink()</code> to specify a mechanism to resolve each link to a data file.</p>
<h2>Terminating analyses</h2>
<p>Once a particular analysis is finished, we should free the resources of its state.</p>
<pre class="prettyprint source lang-js"><code>bakana.freeAnalysis(state);
</code></pre>
<p>If all analyses are complete, we can terminate the entire session.
This is necessary on Node.js to allow the runtime to exit properly.</p>
<pre class="prettyprint source lang-js"><code>bakana.terminate();
</code></pre>
<h2>Developer notes</h2>
<p>See <a href="docs/related/custom_readers.md">here</a> for instructions on adding custom dataset readers.
This allows us to use <strong>bakana</strong>'s analysis pipeline and serialization capabilities on datasets from other sources such as in-house databases.</p>
<p>Testing requires some combination of the options below,
depending on the version of Node.js available.</p>
<pre class="prettyprint source lang-sh"><code>node --experimental-vm-modules \
    --experimental-wasm-threads \
    --experimental-wasm-bulk-memory \
    --experimental-wasm-bigint \
    node_modules/jest/bin/jest.js \
    --testTimeout=100000000 \
    --runInBand
</code></pre></article>
    </section>






    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Aug 22 2022 19:30:07 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>